<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SSD Attendance</title>

<style>
body{
  font-family:'Poppins',sans-serif;
  background:#000080;
  color:white;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding:16px;
  min-height:100vh;
}
.container{
  background:#000022;
  padding:20px;
  border-radius:10px;
  border:2px solid red;
  width:100%;
  max-width:600px;
  text-align:center;
}
h2{color:#ff0000;}
input,button{
  padding:8px;
  margin:5px 0;
  border-radius:5px;
  border:none;
  outline:none;
}
input[type=text]{width:100%;}
button{
  cursor:pointer;
  background:#111;
  color:white;
  font-weight:600;
}
button:hover{opacity:.9}
.hidden{display:none;}
#logo{
  width:120px;height:120px;
  border-radius:50%;
  margin-bottom:10px;
  border:2px solid red;
}
.roleBtn{
  display:flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border:1px solid #fff;
  background:#000;
  color:#fff;
  min-width:170px;
}
.roleBox{ width:14px;height:14px;border:2px solid #fff; }
.roleBtn.active{ border-color:#00ff88; }
.roleBtn.active .roleBox{ background:#00ff88; }
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #fff;padding:6px;}
th{background:#222;}
small{opacity:.8}
.status{
  margin-top:10px;
  padding:8px;
  border:1px solid #444;
  border-radius:8px;
  text-align:left;
  font-size:13px;
  white-space:pre-wrap;
}
.badge{
  display:inline-block;
  padding:4px 8px;
  border:1px solid #fff;
  border-radius:999px;
  font-size:12px;
  margin-left:6px;
}
.badge.on{ border-color:#ff4444; color:#ffaaaa; }
.badge.off{ border-color:#00ff88; color:#b8ffd8; }
</style>
</head>

<body>
<div class="container">

<img id="logo" src="https://i.postimg.cc/7YKMkCFf/file-000000004aa471fa98fe9bf6b8d84453.png" alt="logo">

<!-- MEMBER FORM -->
<div id="memberForm">
  <h2>SSD ATTENDANCE FORM</h2>

  <form id="attendanceForm">
    <label>NAME:</label>
    <input type="text" id="nameInput" required>

    <label>IGN CPM:</label>
    <input type="text" id="ignInput" required>

    <label>ID CPM:</label>
    <input type="text" id="cpmIdInput" required>

    <label>ROLES:</label>

    <div style="display:flex;flex-direction:column;gap:6px;margin:10px 0;align-items:flex-start;">
      <button type="button" class="roleBtn" data-role="Owner"><div class="roleBox"></div> Owner</button>
      <button type="button" class="roleBtn" data-role="Co owner"><div class="roleBox"></div> Co owner</button>
      <button type="button" class="roleBtn" data-role="President"><div class="roleBox"></div> President</button>
      <button type="button" class="roleBtn" data-role="Vice president"><div class="roleBox"></div> Vice president</button>
      <button type="button" class="roleBtn" data-role="Admin"><div class="roleBox"></div> Admin</button>
      <button type="button" class="roleBtn" data-role="Members"><div class="roleBox"></div> Members</button>
    </div>

    <!-- hidden checkboxes -->
    <div class="hidden" id="roleCheckboxes">
      <input type="checkbox" name="roles" value="Owner">
      <input type="checkbox" name="roles" value="Co owner">
      <input type="checkbox" name="roles" value="President">
      <input type="checkbox" name="roles" value="Vice president">
      <input type="checkbox" name="roles" value="Admin">
      <input type="checkbox" name="roles" value="Members">
    </div>

    <button id="submitBtn" type="submit">SUBMIT FORM</button>
  </form>

  <button id="adminLoginBtn">Admin Login</button>

  <div class="status" id="statusBox">Status: Ready</div>
  <small>Members link: Netlify URL</small>
</div>

<!-- ADMIN DASHBOARD -->
<div id="adminDashboard" class="hidden">
  <h2>
    Admin Dashboard
    <span id="maintBadge" class="badge off">MAINTENANCE: OFF</span>
  </h2>

  <div style="margin-top:10px;">
    <button id="maintenanceBtn">Turn Maintenance ON</button>
    <button id="refreshBtn">Refresh</button>
    <button id="resetBtn">Reset Attendance Members</button>
    <button id="downloadBtn">Download Attendance CSV</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>No</th><th>Name</th><th>IGN</th><th>ID</th><th>Roles</th>
      </tr>
    </thead>
    <tbody id="adminTable"></tbody>
  </table>

  <button id="logoutBtn">Logout Admin</button>
  <div class="status" id="adminStatusBox">Admin status: Ready</div>
</div>

</div>

<script>
/* =========================
   CONFIG
========================= */
const SCRIPT_URL = "https://console.firebase.google.com/project/ssdwebsiteAttendance/overview"; // must end with /exec
const ADMIN_KEY  = "SSD_ADMIN_2025"; // must match backend

/* =========================
   ELEMENTS
========================= */
const attendanceForm  = document.getElementById('attendanceForm');
const submitBtn       = document.getElementById('submitBtn');
const nameInput       = document.getElementById('nameInput');
const ignInput        = document.getElementById('ignInput');
const cpmIdInput      = document.getElementById('cpmIdInput');

const memberForm      = document.getElementById('memberForm');
const adminDashboard  = document.getElementById('adminDashboard');
const adminLoginBtn   = document.getElementById('adminLoginBtn');
const logoutBtn       = document.getElementById('logoutBtn');

const maintenanceBtn  = document.getElementById('maintenanceBtn');
const maintBadge      = document.getElementById('maintBadge');

const refreshBtn      = document.getElementById('refreshBtn');
const resetBtn        = document.getElementById('resetBtn');
const downloadBtn     = document.getElementById('downloadBtn');
const adminTable      = document.getElementById('adminTable');

const statusBox       = document.getElementById('statusBox');
const adminStatusBox  = document.getElementById('adminStatusBox');

/* =========================
   ROLE BUTTONS
========================= */
const roleBtns = document.querySelectorAll('.roleBtn');
const roleCheckboxes = document.querySelectorAll('#roleCheckboxes input');

roleBtns.forEach(btn=>{
  btn.addEventListener('click',()=>{
    const role = btn.dataset.role;
    const cb = [...roleCheckboxes].find(c=>c.value===role);
    cb.checked = !cb.checked;
    btn.classList.toggle('active', cb.checked);
  });
});

/* =========================
   HELPERS
========================= */
function setStatus(msg){ statusBox.textContent = "Status: " + msg; }
function setAdminStatus(msg){ adminStatusBox.textContent = "Admin status: " + msg; }
function escapeHtml(str){
  return String(str ?? "").replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[s]));
}
function requireUrl(){
  if (!SCRIPT_URL || SCRIPT_URL.includes("PASTE_YOUR")) {
    setStatus("SCRIPT_URL not set.");
    alert("Paste your Google Apps Script Web App URL (ends with /exec) into SCRIPT_URL.");
    return false;
  }
  return true;
}

/* =========================
   API (text/plain avoids CORS preflight)
========================= */
async function apiGetConfig() {
  const res = await fetch(SCRIPT_URL + "?mode=config", { method:"GET" });
  const text = await res.text();
  if (!res.ok) throw new Error(`GET config HTTP ${res.status}: ${text.slice(0,120)}`);
  return JSON.parse(text);
}
async function apiGetAttendance() {
  const res = await fetch(SCRIPT_URL, { method:"GET" });
  const text = await res.text();
  if (!res.ok) throw new Error(`GET HTTP ${res.status}: ${text.slice(0,120)}`);
  return JSON.parse(text);
}
async function apiPost(payload) {
  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  });
  const text = await res.text();
  if (!res.ok) throw new Error(`POST HTTP ${res.status}: ${text.slice(0,120)}`);
  const out = JSON.parse(text);
  if (!out.ok) throw new Error(out.error || "Request failed");
  return out;
}

/* =========================
   MAINTENANCE
========================= */
let maintenanceOn = false;

function applyMaintenanceUI() {
  if (maintenanceOn) {
    submitBtn.disabled = true; // shutdown submit only
    setStatus("MAINTENANCE ON: Submit disabled (fill-up allowed).");
    maintBadge.textContent = "MAINTENANCE: ON";
    maintBadge.classList.remove("off");
    maintBadge.classList.add("on");
    maintenanceBtn.textContent = "Turn Maintenance OFF";
  } else {
    submitBtn.disabled = false;
    setStatus("Ready");
    maintBadge.textContent = "MAINTENANCE: OFF";
    maintBadge.classList.remove("on");
    maintBadge.classList.add("off");
    maintenanceBtn.textContent = "Turn Maintenance ON";
  }
}

async function refreshMaintenance() {
  if (!requireUrl()) return;
  try {
    const cfg = await apiGetConfig();
    maintenanceOn = !!cfg.maintenance;
    applyMaintenanceUI();
  } catch (e) {
    setStatus("Config error: " + e.message);
  }
}

/* =========================
   SUBMIT
========================= */
attendanceForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!requireUrl()) return;

  if (maintenanceOn) return alert("Maintenance mode is ON. Submit is disabled.");

  const roles = [...roleCheckboxes].filter(c => c.checked).map(c => c.value).join(', ');

  const payload = {
    action: "submit",
    name: nameInput.value.trim(),
    ign: ignInput.value.trim(),
    cpmId: cpmIdInput.value.trim(),
    roles
  };

  try {
    submitBtn.disabled = true;
    setStatus("Submitting...");
    await apiPost(payload);
    setStatus("Submitted ✅ (saved online)");
    alert("Attendance submitted! Saved online.");

    e.target.reset();
    roleCheckboxes.forEach(c=>c.checked=false);
    roleBtns.forEach(b=>b.classList.remove('active'));
  } catch (err) {
    setStatus("ERROR: " + err.message);
    alert("Error: " + err.message);
  } finally {
    submitBtn.disabled = maintenanceOn;
  }
});

/* =========================
   ADMIN LOGIN
========================= */
adminLoginBtn.onclick = async () => {
  const u = prompt('Username:');
  const p = prompt('Password:');

  if (u === 'ssdadmin2025' && p === 'Admincpmoi2025') {
    memberForm.classList.add('hidden');
    adminDashboard.classList.remove('hidden');
    if (requireUrl()) {
      await renderTable();
      await refreshMaintenance();
    }
  } else {
    alert('Invalid credentials');
  }
};

logoutBtn.onclick = () => {
  adminDashboard.classList.add('hidden');
  memberForm.classList.remove('hidden');
};

refreshBtn.onclick = async () => {
  if (!requireUrl()) return;
  await renderTable();
  await refreshMaintenance();
};

/* Toggle maintenance */
maintenanceBtn.onclick = async () => {
  if (!requireUrl()) return;
  try {
    const next = !maintenanceOn;
    setAdminStatus("Updating maintenance...");
    const out = await apiPost({ action:"setMaintenance", adminKey: ADMIN_KEY, on: next });
    maintenanceOn = !!out.maintenance;
    applyMaintenanceUI();
    setAdminStatus("Maintenance updated ✅");
  } catch (err) {
    setAdminStatus("Maintenance error: " + err.message);
    alert("Maintenance error: " + err.message);
  }
};

/* =========================
   ADMIN TABLE
========================= */
async function renderTable(){
  try {
    setAdminStatus("Loading...");
    const data = await apiGetAttendance();

    adminTable.innerHTML = "";
    if (!Array.isArray(data) || data.length === 0) {
      adminTable.innerHTML = `<tr><td colspan="5">No data yet.</td></tr>`;
      setAdminStatus("Loaded (0 rows)");
      return;
    }

    data.forEach((d,i)=>{
      adminTable.innerHTML += `
        <tr>
          <td>${i+1}</td>
          <td>${escapeHtml(d.name)}</td>
          <td>${escapeHtml(d.ign)}</td>
          <td>${escapeHtml(d.cpmId)}</td>
          <td>${escapeHtml(d.roles)}</td>
        </tr>`;
    });

    setAdminStatus("Loaded (" + data.length + " rows) ✅");
  } catch (err) {
    adminTable.innerHTML = `<tr><td colspan="5">Error loading: ${escapeHtml(err.message)}</td></tr>`;
    setAdminStatus("ERROR: " + err.message);
  }
}

/* =========================
   RESET / DOWNLOAD
========================= */
resetBtn.onclick = async () => {
  if (!requireUrl()) return;
  if (!confirm("Reset all attendance ONLINE?")) return;
  try {
    setAdminStatus("Resetting...");
    await apiPost({ action:"reset", adminKey: ADMIN_KEY });
    await renderTable();
    alert("Reset done!");
  } catch (err) {
    setAdminStatus("RESET ERROR: " + err.message);
    alert("Reset error: " + err.message);
  }
};

downloadBtn.onclick = async () => {
  if (!requireUrl()) return;
  try {
    setAdminStatus("Preparing CSV...");
    const data = await apiGetAttendance();
    if (!Array.isArray(data) || data.length === 0) return alert("No data");

    const header = "Name,IGN,CPM ID,Roles";
    const csv = header + "\n" + data
      .map(d => `"${(d.name||"").replace(/"/g,'""')}","${(d.ign||"").replace(/"/g,'""')}","${(d.cpmId||"").replace(/"/g,'""')}","${(d.roles||"").replace(/"/g,'""')}"`)
      .join("\n");

    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
    a.download = "attendance.csv";
    a.click();

    setAdminStatus("CSV downloaded ✅");
  } catch (err) {
    setAdminStatus("CSV ERROR: " + err.message);
    alert("Download error: " + err.message);
  }
};

/* Auto-check maintenance every 10s (members) */
setInterval(() => {
  if (!SCRIPT_URL || SCRIPT_URL.includes("PASTE_YOUR")) return;
  apiGetConfig().then(cfg=>{
    maintenanceOn = !!cfg.maintenance;
    applyMaintenanceUI();
  }).catch(()=>{});
}, 10000);
</script>

</body>
</html>
