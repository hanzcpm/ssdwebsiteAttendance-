<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SSD Attendance</title>

<style>
body{
  font-family:'Poppins',sans-serif;
  background:#000080;
  color:white;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding:16px;
  min-height:100vh;
}
.container{
  background:#000022;
  padding:20px;
  border-radius:10px;
  border:2px solid red;
  width:100%;
  max-width:600px;
  text-align:center;
}
h2{color:#ff0000;}

input,button{
  padding:8px;
  margin:5px 0;
  border-radius:5px;
  border:none;
  outline:none;
}
input[type=text],input[type=time]{width:100%;}

button{
  cursor:pointer;
  background:#111;
  color:white;
  font-weight:600;
}
button:hover{opacity:.9}

.hidden{display:none;}

#logo{
  width:120px;height:120px;
  border-radius:50%;
  margin-bottom:10px;
  border:2px solid red;
}

/* ROLE BUTTON STYLE */
.roleBtn{
  display:flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border:1px solid #fff;
  background:#000;
  color:#fff;
  min-width:170px;
}
.roleBox{
  width:14px;
  height:14px;
  border:2px solid #fff;
}
.roleBtn.active{
  border-color:#00ff88;
}
.roleBtn.active .roleBox{
  background:#00ff88;
}

/* TABLE */
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #fff;padding:6px;}
th{background:#222;}
small{opacity:.8}
</style>
</head>

<body>

<div class="container">

<img id="logo" src="https://i.postimg.cc/7YKMkCFf/file-000000004aa471fa98fe9bf6b8d84453.png" alt="logo">

<!-- MEMBER FORM -->
<div id="memberForm">
  <h2>SSD ATTENDANCE FORM</h2>

  <form id="attendanceForm">
    <label>NAME:</label>
    <input type="text" id="nameInput" required>

    <label>IGN CPM:</label>
    <input type="text" id="ignInput" required>

    <label>ID CPM:</label>
    <input type="text" id="cpmIdInput" required>

    <label>ROLES:</label>

    <div style="display:flex;flex-direction:column;gap:6px;margin:10px 0;align-items:flex-start;">

      <button type="button" class="roleBtn" data-role="Owner">
        <div class="roleBox"></div> Owner
      </button>
      <button type="button" class="roleBtn" data-role="Co owner">
        <div class="roleBox"></div> Co owner
      </button>
      <button type="button" class="roleBtn" data-role="President">
        <div class="roleBox"></div> President
      </button>
      <button type="button" class="roleBtn" data-role="Vice president">
        <div class="roleBox"></div> Vice president
      </button>
      <button type="button" class="roleBtn" data-role="Admin">
        <div class="roleBox"></div> Admin
      </button>
      <button type="button" class="roleBtn" data-role="Members">
        <div class="roleBox"></div> Members
      </button>

    </div>

    <!-- hidden checkboxes -->
    <div class="hidden" id="roleCheckboxes">
      <input type="checkbox" name="roles" value="Owner">
      <input type="checkbox" name="roles" value="Co owner">
      <input type="checkbox" name="roles" value="President">
      <input type="checkbox" name="roles" value="Vice president">
      <input type="checkbox" name="roles" value="Admin">
      <input type="checkbox" name="roles" value="Members">
    </div>

    <button type="submit">SUBMIT FORM</button>
  </form>

  <button id="adminLoginBtn">Admin Login</button>
  <div style="margin-top:6px;">
    <small>Online save: Google Sheet (works on Chrome)</small>
  </div>
</div>

<!-- ADMIN DASHBOARD -->
<div id="adminDashboard" class="hidden">
  <h2>Admin Dashboard</h2>

  <label>Reset Time:
    <input type="time" id="resetTimeInput">
  </label>
  <button id="setTimeBtn">Set Time</button>

  <div style="margin-top:10px;">
    <button id="resetBtn">Reset Attendance Members</button>
    <button id="downloadBtn">Download Attendance CSV</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>No</th><th>Name</th><th>IGN</th><th>ID</th><th>Roles</th>
      </tr>
    </thead>
    <tbody id="adminTable"></tbody>
  </table>

  <button id="logoutBtn">Logout Admin</button>
</div>

</div>

<script>
/* =========================
   CONFIG (EDIT THIS)
========================= */
const SCRIPT_URL = "https://ssdwebattendance.netlify.app/";
const ADMIN_KEY  = "SSD_ADMIN_2025";

/* =========================
   ELEMENTS
========================= */
const attendanceForm = document.getElementById('attendanceForm');
const nameInput = document.getElementById('nameInput');
const ignInput = document.getElementById('ignInput');
const cpmIdInput = document.getElementById('cpmIdInput');

const memberForm = document.getElementById('memberForm');
const adminDashboard = document.getElementById('adminDashboard');
const adminLoginBtn = document.getElementById('adminLoginBtn');
const logoutBtn = document.getElementById('logoutBtn');

const resetBtn = document.getElementById('resetBtn');
const downloadBtn = document.getElementById('downloadBtn');
const adminTable = document.getElementById('adminTable');

const resetTimeInput = document.getElementById('resetTimeInput');
const setTimeBtn = document.getElementById('setTimeBtn');

let attendanceData = []; // server data
let resetTime = localStorage.getItem('ssdResetTime') || null;

/* =========================
   ROLE BUTTONS
========================= */
const roleBtns = document.querySelectorAll('.roleBtn');
const roleCheckboxes = document.querySelectorAll('#roleCheckboxes input');

roleBtns.forEach(btn=>{
  btn.addEventListener('click',()=>{
    const role = btn.dataset.role;
    const cb = [...roleCheckboxes].find(c=>c.value===role);
    cb.checked = !cb.checked;
    btn.classList.toggle('active', cb.checked);
  });
});

/* =========================
   API HELPERS
========================= */
async function apiGetAttendance() {
  const res = await fetch(SCRIPT_URL, { method: "GET" });
  if (!res.ok) throw new Error("Cannot load attendance");
  return await res.json();
}

async function apiSubmitAttendance(payload) {
  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  });
  const out = await res.json().catch(()=>({ok:false,error:"Bad response"}));
  if (!out.ok) throw new Error(out.error || "Submit failed");
  return out;
}

async function apiResetAttendance() {
  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({ action: "reset", adminKey: ADMIN_KEY })
  });
  const out = await res.json().catch(()=>({ok:false,error:"Bad response"}));
  if (!out.ok) throw new Error(out.error || "Reset failed");
  return out;
}

/* =========================
   SUBMIT FORM (ONLINE SAVE)
========================= */
attendanceForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  if (!SCRIPT_URL || SCRIPT_URL.includes("PASTE_YOUR")) {
    return alert("Error: PASTE your Apps Script Web App URL first!");
  }

  const roles = [...roleCheckboxes]
    .filter(c => c.checked)
    .map(c => c.value)
    .join(', ');

  const payload = {
    action: "submit",
    name: nameInput.value.trim(),
    ign: ignInput.value.trim(),
    cpmId: cpmIdInput.value.trim(),
    roles
  };

  try {
    await apiSubmitAttendance(payload);

    alert("Attendance submitted (saved online)!");
    e.target.reset();

    roleCheckboxes.forEach(c=>c.checked=false);
    roleBtns.forEach(b=>b.classList.remove('active'));

  } catch (err) {
    alert("Error: " + err.message);
  }
});

/* =========================
   ADMIN LOGIN
========================= */
adminLoginBtn.onclick = async () => {
  const u = prompt('Username:');
  const p = prompt('Password:');

  if (u === 'ssdadmin2025' && p === 'Admincpmoi2025') {
    memberForm.classList.add('hidden');
    adminDashboard.classList.remove('hidden');
    await renderTable();
  } else {
    alert('Invalid credentials');
  }
};

logoutBtn.onclick = () => {
  adminDashboard.classList.add('hidden');
  memberForm.classList.remove('hidden');
};

/* =========================
   RENDER TABLE (FROM SERVER)
========================= */
async function renderTable(){
  try {
    attendanceData = await apiGetAttendance();

    adminTable.innerHTML = '';
    attendanceData.forEach((d,i)=>{
      adminTable.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${escapeHtml(d.name || "")}</td>
        <td>${escapeHtml(d.ign || "")}</td>
        <td>${escapeHtml(d.cpmId || "")}</td>
        <td>${escapeHtml(d.roles || "")}</td>
      </tr>`;
    });
  } catch (err) {
    adminTable.innerHTML = `<tr><td colspan="5">Error loading: ${escapeHtml(err.message)}</td></tr>`;
  }
}

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[s]));
}

/* =========================
   RESET (SERVER CLEAR)
========================= */
resetBtn.onclick = async () => {
  if (!confirm('Reset all attendance ONLINE?')) return;
  try {
    await apiResetAttendance();
    await renderTable();
    alert("Attendance reset (online)!");
  } catch (err) {
    alert("Error: " + err.message);
  }
};

/* =========================
   DOWNLOAD CSV (SERVER DATA)
========================= */
downloadBtn.onclick = async () => {
  try {
    attendanceData = await apiGetAttendance();
    if (attendanceData.length === 0) return alert("No data");

    const header = "Name,IGN,CPM ID,Roles";
    const csv = header + "\n" + attendanceData
      .map(d => `"${(d.name||"").replace(/"/g,'""')}","${(d.ign||"").replace(/"/g,'""')}","${(d.cpmId||"").replace(/"/g,'""')}","${(d.roles||"").replace(/"/g,'""')}"`)
      .join("\n");

    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    a.download = 'attendance.csv';
    a.click();
  } catch (err) {
    alert("Error: " + err.message);
  }
};

/* =========================
   RESET TIME (LOCAL SETTING)
   - This triggers ONLINE reset once per day at set time.
========================= */
if (resetTime) resetTimeInput.value = resetTime;

setTimeBtn.onclick = () => {
  resetTime = resetTimeInput.value;
  localStorage.setItem('ssdResetTime', resetTime);
  alert('Reset time set (this device only).');
};

// auto refresh table if admin is open
setInterval(() => {
  if (!adminDashboard.classList.contains("hidden")) renderTable();
}, 8000);

// AUTO RESET ONCE PER DAY
setInterval(async () => {
  if (!resetTime) return;

  const now = new Date();
  const [h,m] = resetTime.split(':').map(Number);

  if (now.getHours() === h && now.getMinutes() === m) {
    const todayKey = now.toISOString().slice(0,10);
    const lastKey = localStorage.getItem("ssdLastAutoReset") || "";

    if (lastKey !== todayKey) {
      try {
        await apiResetAttendance();
        localStorage.setItem("ssdLastAutoReset", todayKey);
        if (!adminDashboard.classList.contains("hidden")) await renderTable();
      } catch (e) {
        // silent
      }
    }
  }
}, 60000);
</script>

</body>
</html>
